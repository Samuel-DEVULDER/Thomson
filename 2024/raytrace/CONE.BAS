6000 REM *************************
6001 REM **     RAY-TRACING     **
6002 REM ** (C) DEVULDER Samuel **
6003 REM **         1989        **
6004 REM *************************
6005 CLEAR,,16
6006 GOSUB  6121
6007 FOR I%=0 TO 15
6008 A%=I%+16*I%
6009 DEFGR$(I%)=A%,A%,A%,A%,A%,A%,A%,A%
6010 PALETTE I%,273*I%
6011 NEXT
6012 GOSUB  6127
6013 DIM I(10)  ' PILE DES INTENSITES
6014 X0=40      'POSITION
6015 Y0=0       'DE L'
6016 Z0=10      'OEIL
6017 XE=20      'POSITION
6018 YE=0       'DE L'
6019 ZE=5       'ECRAN
6020 XO=0       'POSITION
6021 YO=0       'DE L'
6022 ZO=5       'OBJET
6023 XL=15      'POSITION
6024 YL=15      'DE LA
6025 ZL=7       'LUMIERE
6026 RL=2       'RAYON
6027 IA=1/15    'INTENSITE AMBIANTE
6028 UX=YE-Y0
6029 UY=X0-XE
6030 UZ=0
6031 R=SQR(UX*UX+UY*UY+UZ*UZ)
6032 UX=UX/R
6033 UY=UY/R
6034 VX=(ZE-Z0)*(XE-X0)
6035 VY=(ZE-Z0)*(YE-Y0)
6036 VZ=(XE-X0)^2+(YE-Y0)^2
6037 R=SQR(VX*VX+VY*VY+VZ*VZ)
6038 VX=VX/R
6039 VY=VY/R
6040 VZ=VZ/R
6041 BA%=4
6042 FOR J1%=0 TO 200@BA%
6043 FOR I1%=0 TO 160@BA%
6044 J%=100-J1%*BA%
6045 I%=2*I1%*BA%-160
6046 X1=X0
6047 Y1=Y0
6048 Z1=Z0
6049 X2=(XE-X0)+3*(UX*I%+VY*J%)/100
6050 Y2=(YE-Y0)+3*(UY*I%+VY*J%)/100
6051 Z2=(ZE-Z0)+3*(UZ*I%+VZ*J%)/100
6052 N%=0
6053 GOSUB  6062
6054 PATTERN128+15*I(1)
6055 BOXF(4*I1%-1,J1%-1)-(4*I1%+4,J1%+1)
6056 BOX(4*I1%-1,J1%-1)-(4*I1%+4,J1%+1)
6057 NEXT
6058 NEXT
6059 SCREEN,,1
6060 A$=INPUT$(1)
6061 GOTO 5000
6062 'RAYON:
6063 N%=N%+1
6064 IF N%<>10 THEN GOSUB 6135
6065 N%=N%-1
6066 RETURN
6067 'RFL:
6068 SC=2*(XN*X2+YN*Y2+ZN*Z2)
6069 X2=X2-SC*XN
6070 Y2=Y2-SC*YN
6071 Z2=Z2-SC*ZN
6072 RETURN
6073 'OMBRE:
6074 DM=ABS(X1-XL)+ABS(Y1-YL)+ABS(Z1-ZL)
6075 CC=C
6076 GOSUB  6113
6077 TST=0
6078 C=CC
6079 IF DM<ABS(X1-XL)+ABS(Y1-YL)+ABS(Z1-ZL) THEN GOSUB 6153
6080 RETURN
6081 'CIEL:
6082 CP=-2
6083 DM=1E38
6084 RETURN
6085 'TSTLAMPE:
6086 TST=0
6087 A=X2*X2+Y2*Y2+Z2*Z2
6088 B=X2*(X1-XL)+Y2*(Y1-YL)+Z2*(Z1-ZL)
6089 C=(X1-XL)^2+(Y1-YL)^2+(Z1-ZL)^2-RL^2
6090 D=B*B-A*C
6091 IF D>=0 THEN GOSUB 6156
6092 RETURN
6093 'LAMPE:
6094 GOSUB  6085
6095 IF TST=-1 THEN GOSUB 6164
6096 RETURN
6097 'TSTPLAN:
6098 K=-Z1/Z2
6099 TST=(K>0)
6100 RETURN
6101 'PLAN:
6102 GOSUB  6097
6103 IF TST=-1 THEN GOSUB 6171
6104 RETURN
6105 'TSTOBJET:
6106 TST=0
6107 A=Z2*Z2-X2*X2-Y2*Y2
6108 B=Z2*(Z1-ZO)-X2*(X1-XO)-Y2*(Y1-YO)
6109 C=(Z1-ZO)^2-(X1-XO)^2-(Y1-YO)^2
6110 D=B*B-A*C
6111 IF D>=0 THEN GOSUB 6181
6112 RETURN
6113 'OBJET:
6114 GOSUB  6105
6115 IF TST=-1 THEN GOSUB 6190
6116 RETURN
6117 'DISTANCE:
6118 D=ABS(X-X1)+ABS(Y-Y1)+ABS(Z-Z1)
6119 IF D>.001 AND D<DM THEN GOSUB 6204
6120 RETURN
6121 '320x200:
6122 CONSOLE0,24,0,0,0
6123 SCREEN2,0,0
6124 LOCATE 0,0,0
6125 CLS
6126 RETURN
6127 '160x200:
6128 IF PEEK(&HFFF0)=2 THEN GOSUB 6214
6129 CONSOLE,,5,,1
6130 POKE &HE7DC,123
6131 SCREEN,,0
6132 RETURN
6133 GOTO 5000
6134 GOTO 5000
6135 '*IF0:
6136 I(N%)=0
6137 GOSUB  6081
6138 GOSUB  6101
6139 GOSUB  6113
6140 GOSUB  6093
6141 C=CP
6142 XN=XNP:YN=YNP:ZN=ZNP
6143 X=XP:Y=YP:Z=ZP
6144 ' C=1  DIFFUSION
6145 ' C=0  MIROIR
6146 ' C=-1 LAMPE
6147 ' C=-2 CIEL NOIR
6148 IF C=-1 THEN GOSUB 6219
6149 IF C=1 THEN GOSUB 6222
6150 IF C=0 THEN GOSUB 6228
6151 IF C=-2 THEN GOSUB 6234
6152 RETURN
6153 '*IF1:
6154 TST=-1
6155 RETURN
6156 '*IF2:
6157 TST=-1
6158 D=SQR(D)
6159 K1=(-B-D)/A
6160 K2=(-B+D)/A
6161 K=MIN(K1,K2)
6162 IF K<0 THEN GOSUB 6237
6163 RETURN
6164 '*IF3:
6165 C=-1
6166 X=XL
6167 Y=YL
6168 Z=ZL
6169 GOSUB  6117
6170 RETURN
6171 '*IF4:
6172 X=X1+K*X2
6173 Y=Y1+K*Y2
6174 Z=0
6175 XN=0
6176 YN=0
6177 ZN=1
6178 C=1
6179 GOSUB  6117
6180 RETURN
6181 '*IF5:
6182 TST=-1
6183 D=SQR(D)
6184 K1=(-B-D)/A
6185 K2=(-B+D)/A
6186 K=MIN(K1,K2)
6187 IF K<0 THEN GOSUB 6241
6188 TST=-TST*(Z1+K*Z2<=ZO)
6189 RETURN
6190 '*IF6:
6191 X=X1+K*X2
6192 Y=Y1+K*Y2
6193 Z=Z1+K*Z2
6194 C=1
6195 XN=(X-XO)
6196 YN=(Y-YO)
6197 ZN=SQR(XN*XN+YN*YN)
6198 R=SQR(XN*XN+YN*YN+ZN*ZN)
6199 XN=XN/R
6200 YN=YN/R
6201 ZN=ZN/R
6202 GOSUB  6117
6203 RETURN
6204 '*IF7:
6205 DM=D
6206 XP=X
6207 YP=Y
6208 ZP=Z
6209 XNP=XN
6210 YNP=YN
6211 ZNP=ZN
6212 CP=C
6213 RETURN
6214 '*IF8:
6215 P%=PALETTE(6)
6216 PALETTE6,PALETTE(1)
6217 PALETTE1,P%
6218 RETURN
6219 '*IF9:
6220 I(N%)=1
6221 RETURN
6222 '*IF10:
6223 X1=X:Y1=Y:Z1=Z
6224 X2=XL-X:Y2=YL-Y:Z2=ZL-Z
6225 GOSUB  6073
6226 IF TST=-1 OR X2*XN+Y2*YN+Z2*ZN<0 THEN GOSUB 6245 ELSE GOSUB 6248
6227 RETURN
6228 '*IF11:
6229 GOSUB  6067
6230 X1=X:Y1=Y:Z1=Z
6231 GOSUB  6062
6232 I(N%)=I(N%+1)
6233 RETURN
6234 '*IF12:
6235 I(N%)=0
6236 RETURN
6237 '*IF13:
6238 K=MAX(K1,K2)
6239 IF K<0 THEN GOSUB 6252
6240 RETURN
6241 '*IF14:
6242 K=MAX(K1,K2)
6243 IF K<0 THEN GOSUB 6255
6244 RETURN
6245 '*IF15:
6246 I(N%)=IA
6247 RETURN
6248 '*IF16:
6249 R=SQR(X2*X2+Y2*Y2+Z2*Z2)
6250 I(N%)=IA+(1-IA)*(X2*XN+Y2*YN+Z2*ZN)/R
6251 RETURN
6252 '*IF17:
6253 TST=0
6254 RETURN
6255 '*IF18:
6256 TST=0
6257 RETURN
