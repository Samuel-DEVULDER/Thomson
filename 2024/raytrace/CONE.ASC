REM *************************
REM **     RAY-TRACING     **
REM ** (C) DEVULDER Samuel **
REM **         1989        **
REM *************************

GOSUB 320x200
SX%=1
IF 0
  CLEAR,,16
  FOR I%=0 TO 15
    A%=I%+16*I%
    DEFGR$(I%)=A%,A%,A%,A%,A%,A%,A%,A%
    PALETTE I%,273*I%
  NEXT
  GOSUB 160x200
  SX%=2
ENDIF

DIM E(322)
DIM I(10)  ' PILE DES INTENSITES

X0=40      'POSITION
Y0=0       'DE L'
Z0=10      'OEIL

XE=20      'POSITION
YE=0       'DE L'
ZE=5       'ECRAN

XO=0       'POSITION
YO=0       'DE L'
ZO=5       'OBJET

XL=15      'POSITION
YL=15      'DE LA
ZL=7       'LUMIERE
RL=2       'RAYON

IA=1/15    'INTENSITE AMBIANTE 

UX=YE-Y0
UY=X0-XE
UZ=0
R=SQR(UX*UX+UY*UY+UZ*UZ)
UX=UX/R
UY=UY/R
VX=(ZE-Z0)*(XE-X0)
VY=(ZE-Z0)*(YE-Y0)
VZ=(XE-X0)^2+(YE-Y0)^2
R=SQR(VX*VX+VY*VY+VZ*VZ)
VX=VX/R
VY=VY/R
VZ=VZ/R

BA%=1

FOR J1%=0 TO 200@BA%-1
  FOR I1%=0 TO 320@BA%@SX%-1
    J%=100-J1%*BA%
    I%=SX%*I1%*BA%-160
    X1=X0
    Y1=Y0
    Z1=Z0
    X2=(XE-X0)+3*(UX*I%+VY*J%)/100
    Y2=(YE-Y0)+3*(UY*I%+VY*J%)/100
    Z2=(ZE-Z0)+3*(UZ*I%+VZ*J%)/100
    N%=0
    GOSUB RAYON
    GOSUB PLOT
  NEXT
NEXT
SCREEN,,1
A$=INPUT$(1)
END

PLOT:
  ' Diffusion d erreur
  E=I(1)+E(I1%+1)
  IF E>.5
    PSET(I1%,J1%)
    E=E-1
  ENDIF
  E(I1%+2)=E(I1%+2)+E*.5
  E=E*.25
  E(I1%+1)=E
  E(I1%)=E(I1%)+E
RETURN

PlOT16:
  PATTERN128+15*I(1)
  BOXF(4*I1%-1,J1%-1)-(4*I1%+4,J1%+1)
  BOX(4*I1%-1,J1%-1)-(4*I1%+4,J1%+1)
RETURN
RAYON:
  N%=N%+1
  IF N%<>10
    I(N%)=0
    GOSUB CIEL
    GOSUB PLAN
    GOSUB OBJET
    GOSUB LAMPE
    C=CP
    XN=XNP:YN=YNP:ZN=ZNP
    X=XP:Y=YP:Z=ZP

' C=1  DIFFUSION
' C=0  MIROIR
' C=-1 LAMPE
' C=-2 CIEL NOIR 

    IF C=-1
      I(N%)=1
    ENDIF
    IF C=1
      X1=X:Y1=Y:Z1=Z
      X2=XL-X:Y2=YL-Y:Z2=ZL-Z
      GOSUB OMBRE
      IF TST=-1 OR X2*XN+Y2*YN+Z2*ZN<0
        I(N%)=IA
      ELSE
        R=SQR(X2*X2+Y2*Y2+Z2*Z2)
        I(N%)=IA+(1-IA)*(X2*XN+Y2*YN+Z2*ZN)/R
      ENDIF
    ENDIF
    IF C=0
      GOSUB RFL
      X1=X:Y1=Y:Z1=Z
      GOSUB RAYON
      I(N%)=I(N%+1)
    ENDIF
    IF C=-2
      I(N%)=0
    ENDIF
  ENDIF
  N%=N%-1
RETURN

RFL:
  SC=2*(XN*X2+YN*Y2+ZN*Z2)
  X2=X2-SC*XN
  Y2=Y2-SC*YN
  Z2=Z2-SC*ZN
RETURN

OMBRE:
  DM=ABS(X1-XL)+ABS(Y1-YL)+ABS(Z1-ZL)
  CC=C
  GOSUB OBJET
  TST=0
  C=CC
  IF DM<ABS(X1-XL)+ABS(Y1-YL)+ABS(Z1-ZL)
    TST=-1
  ENDIF
RETURN

CIEL:
  CP=-2
  DM=1E38
RETURN

TSTLAMPE:
  TST=0
  A=X2*X2+Y2*Y2+Z2*Z2
  B=X2*(X1-XL)+Y2*(Y1-YL)+Z2*(Z1-ZL)
  C=(X1-XL)^2+(Y1-YL)^2+(Z1-ZL)^2-RL^2
  D=B*B-A*C
  IF D>=0
    TST=-1
    D=SQR(D)
    K1=(-B-D)/A
    K2=(-B+D)/A
    GOSUB MINK1K2
    IF K<0
      GOSUB MAXK1K2
      IF K<0
        TST=0
      ENDIF
    ENDIF
  ENDIF
RETURN

MINK1K2:
  K=K1
  IF K2<K
     K=K2
  ENDIF
RETURN

MAXK1K2:
  K=K2
  IF K1>K
     K=K1
  ENDIF
RETURN

LAMPE:
  GOSUB TSTLAMPE
  IF TST=-1
    C=-1
    X=XL
    Y=YL
    Z=ZL
    GOSUB DISTANCE
  ENDIF
RETURN

TSTPLAN:
  K=-Z1/Z2
  TST=(K>0)
RETURN

PLAN:
  GOSUB TSTPLAN
  IF TST=-1
    X=X1+K*X2
    Y=Y1+K*Y2
    Z=0
    XN=0
    YN=0
    ZN=1
    C=1
    GOSUB DISTANCE
  ENDIF
RETURN

TSTOBJET:
  TST=0
  A=Z2*Z2-X2*X2-Y2*Y2
  B=Z2*(Z1-ZO)-X2*(X1-XO)-Y2*(Y1-YO)
  C=(Z1-ZO)^2-(X1-XO)^2-(Y1-YO)^2
  D=B*B-A*C
  IF D>=0
    TST=-1
    D=SQR(D)
    K1=(-B-D)/A
    K2=(-B+D)/A
    GOSUB MINK1K2
    IF K<0
      GOSUB MAXK1K2
      IF K<0
        TST=0
      ENDIF
    ENDIF
    TST=-TST*(Z1+K*Z2<=ZO) 
  ENDIF
RETURN

OBJET:
  GOSUB TSTOBJET
  IF TST=-1
    X=X1+K*X2
    Y=Y1+K*Y2
    Z=Z1+K*Z2
    C=1
    XN=(X-XO)
    YN=(Y-YO)
    ZN=SQR(XN*XN+YN*YN)
    R=SQR(XN*XN+YN*YN+ZN*ZN)
    XN=XN/R
    YN=YN/R
    ZN=ZN/R
    GOSUB DISTANCE
  ENDIF
RETURN

DISTANCE:
  D=ABS(X-X1)+ABS(Y-Y1)+ABS(Z-Z1)
  IF D>.001 AND D<DM
    DM=D
    XP=X
    YP=Y
    ZP=Z
    XNP=XN
    YNP=YN
    ZNP=ZN
    CP=C
  ENDIF
RETURN

320x200:
  CONSOLE0,24,0,0,0
  SCREEN3,4,4
  LOCATE 0,0,0
  CLS
RETURN

160x200:
  IF PEEK(&HFFF0)=2
    P%=PALETTE(6)
    PALETTE6,PALETTE(1)
    PALETTE1,P%
  ENDIF
  CONSOLE,,5,,1
  POKE &HE7DC,123
  SCREEN,,0
RETURN
END
